<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberShield Analytics | Threat Intelligence Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@300;400;500;600&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Orbitron', 'sans-serif'],
                        'mono': ['JetBrains Mono', 'monospace'],
                        'body': ['Space Grotesk', 'sans-serif'],
                    },
                    colors: {
                        'cyber': {
                            'dark': '#0a0e17',
                            'darker': '#050810',
                            'card': '#111827',
                            'border': '#1e3a5f',
                            'cyan': '#00f0ff',
                            'purple': '#a855f7',
                            'red': '#ff3366',
                            'orange': '#ff9500',
                            'green': '#00ff88',
                            'yellow': '#ffea00',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                        'scan': 'scan 3s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(0, 240, 255, 0.3), 0 0 10px rgba(0, 240, 255, 0.2); }
            to { box-shadow: 0 0 20px rgba(0, 240, 255, 0.5), 0 0 30px rgba(0, 240, 255, 0.3); }
        }
        @keyframes scan {
            0% { background-position: 0% 0%; }
            100% { background-position: 0% 100%; }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes countUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .animate-count { animation: countUp 0.8s ease-out forwards; }
        .animate-slide { animation: slideIn 0.6s ease-out forwards; }
        .animate-fade { animation: fadeIn 1s ease-out forwards; }
        
        .card-glow { animation: glow 2s ease-in-out infinite alternate; }
        
        .grid-bg {
            background-image: 
                linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
        }
        
        .scan-line {
            background: linear-gradient(180deg, transparent 0%, rgba(0, 240, 255, 0.1) 50%, transparent 100%);
            background-size: 100% 200%;
            animation: scan 3s linear infinite;
        }
        
        .cyber-border {
            border: 1px solid rgba(0, 240, 255, 0.2);
            position: relative;
        }
        .cyber-border::before {
            content: '';
            position: absolute;
            top: -1px;
            left: 10%;
            right: 10%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00f0ff, transparent);
        }
        .cyber-border::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 10%;
            right: 10%;
            height: 1px;
            background: linear-gradient(90deg, transparent, #00f0ff, transparent);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .threat-bar {
            position: relative;
            overflow: hidden;
        }
        .threat-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% { left: 100%; }
        }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0e17; }
        ::-webkit-scrollbar-thumb { background: #1e3a5f; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #00f0ff; }
        
        .chart-container { position: relative; }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 8, 16, 0.9);
            backdrop-filter: blur(8px);
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            z-index: 101;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .modal-container.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }
        .modal-glow {
            box-shadow: 0 0 60px rgba(0, 240, 255, 0.15), 0 0 100px rgba(168, 85, 247, 0.1);
        }
        
        .clickable-chart {
            cursor: pointer;
        }
        .clickable-chart:hover {
            filter: brightness(1.1);
        }
        
        @keyframes modalPulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.2); }
            50% { box-shadow: 0 0 40px rgba(0, 240, 255, 0.4); }
        }
        .modal-pulse {
            animation: modalPulse 2s ease-in-out infinite;
        }
        
        .detail-card {
            transition: all 0.2s ease;
        }
        .detail-card:hover {
            transform: translateY(-2px);
            border-color: rgba(0, 240, 255, 0.5);
        }
        
        /* Map Styles */
        #threatMap {
            background: #0a0e17;
            border-radius: 12px;
        }
        .leaflet-container {
            background: #0a0e17 !important;
            font-family: 'Space Grotesk', sans-serif;
        }
        .leaflet-tile {
            filter: brightness(0.6) saturate(0.8) hue-rotate(180deg) invert(1);
        }
        .leaflet-control-zoom {
            border: 1px solid rgba(0, 240, 255, 0.3) !important;
            background: #111827 !important;
        }
        .leaflet-control-zoom a {
            background: #111827 !important;
            color: #00f0ff !important;
            border-color: rgba(0, 240, 255, 0.2) !important;
        }
        .leaflet-control-zoom a:hover {
            background: #1e3a5f !important;
        }
        .leaflet-control-attribution {
            background: rgba(17, 24, 39, 0.8) !important;
            color: #6b7280 !important;
            font-size: 9px !important;
        }
        .leaflet-control-attribution a {
            color: #00f0ff !important;
        }
        
        .cyber-marker {
            position: relative;
        }
        .cyber-marker::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: markerPulse 2s ease-out infinite;
        }
        @keyframes markerPulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 51, 102, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 51, 102, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 51, 102, 0); }
        }
        
        .incident-popup .leaflet-popup-content-wrapper {
            background: #111827 !important;
            border: 1px solid rgba(0, 240, 255, 0.3);
            border-radius: 12px !important;
            box-shadow: 0 0 30px rgba(0, 240, 255, 0.2);
        }
        .incident-popup .leaflet-popup-content {
            margin: 0 !important;
            color: white;
        }
        .incident-popup .leaflet-popup-tip {
            background: #111827 !important;
            border: 1px solid rgba(0, 240, 255, 0.3);
        }
        .leaflet-popup-close-button {
            color: #6b7280 !important;
            font-size: 20px !important;
            padding: 8px !important;
        }
        .leaflet-popup-close-button:hover {
            color: #ff3366 !important;
        }
        
        .attack-line {
            stroke-dasharray: 10, 5;
            animation: dashMove 1s linear infinite;
        }
        @keyframes dashMove {
            to { stroke-dashoffset: -15; }
        }
    </style>
</head>
<body class="bg-cyber-darker text-white font-body min-h-screen grid-bg">
    <!-- Ambient scan effect -->
    <div class="fixed inset-0 scan-line pointer-events-none opacity-30 z-0"></div>
    
    <!-- Header -->
    <header class="relative z-10 border-b border-cyber-border bg-cyber-dark/80 backdrop-blur-xl sticky top-0">
        <div class="max-w-[1920px] mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="relative">
                        <div class="w-12 h-12 bg-gradient-to-br from-cyber-cyan to-cyber-purple rounded-lg flex items-center justify-center animate-float">
                            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                            </svg>
                        </div>
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-cyber-green rounded-full status-dot"></div>
                    </div>
                    <div>
                        <h1 class="font-display text-2xl font-bold tracking-wider text-transparent bg-clip-text bg-gradient-to-r from-cyber-cyan to-cyber-purple">
                            CYBERSHIELD
                        </h1>
                        <p class="text-xs text-gray-500 font-mono tracking-widest">THREAT INTELLIGENCE DASHBOARD</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3 px-4 py-2 bg-cyber-card/50 rounded-lg border border-cyber-border">
                        <span class="text-xs text-gray-400 font-mono">MONITORING</span>
                        <span class="status-dot bg-cyber-green"></span>
                        <span class="text-cyber-green text-sm font-semibold">ACTIVE</span>
                    </div>
                    <div class="text-right">
                        <p class="text-xs text-gray-500 font-mono">LAST UPDATE</p>
                        <p id="lastUpdate" class="text-sm font-mono text-cyber-cyan"></p>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="relative z-10 max-w-[1920px] mx-auto p-6 space-y-6">
        
        <!-- Threat Level Banner -->
        <div id="threatBanner" class="cyber-border rounded-xl p-6 bg-gradient-to-r from-cyber-card via-cyber-dark to-cyber-card overflow-hidden relative">
            <div class="absolute inset-0 bg-gradient-to-r from-cyber-red/5 to-transparent"></div>
            <div class="relative flex items-center justify-between">
                <div class="flex items-center gap-6">
                    <div class="w-20 h-20 rounded-full bg-gradient-to-br from-cyber-orange to-cyber-red flex items-center justify-center card-glow">
                        <span class="font-display text-3xl font-black" id="threatScore">87</span>
                    </div>
                    <div>
                        <h2 class="font-display text-lg tracking-wider text-gray-400">CURRENT THREAT LEVEL</h2>
                        <p id="threatLevel" class="text-3xl font-bold text-cyber-orange">ELEVATED</p>
                        <p class="text-sm text-gray-500 mt-1">Increased DDoS activity detected in the last 24 hours</p>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-8">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono mb-1">BLOCKED TODAY</p>
                        <p class="text-2xl font-bold text-cyber-cyan" id="blockedToday">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono mb-1">ACTIVE INCIDENTS</p>
                        <p class="text-2xl font-bold text-cyber-red" id="activeIncidents">0</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono mb-1">SYSTEMS PROTECTED</p>
                        <p class="text-2xl font-bold text-cyber-green" id="systemsProtected">0</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- KPI Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
            <div class="cyber-border rounded-xl p-4 bg-cyber-card/50 backdrop-blur animate-slide" style="animation-delay: 0.1s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500 font-mono">TOTAL ATTACKS</span>
                    <svg class="w-5 h-5 text-cyber-red" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold" id="totalAttacks">0</p>
                <p class="text-xs text-cyber-red mt-1" id="attacksTrend">↑ 0% vs last week</p>
            </div>
            
            <div class="cyber-border rounded-xl p-4 bg-cyber-card/50 backdrop-blur animate-slide" style="animation-delay: 0.2s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500 font-mono">DOS EVENTS</span>
                    <svg class="w-5 h-5 text-cyber-orange" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold" id="dosEvents">0</p>
                <p class="text-xs text-cyber-orange mt-1" id="dosTrend">↑ 0% vs last week</p>
            </div>
            
            <div class="cyber-border rounded-xl p-4 bg-cyber-card/50 backdrop-blur animate-slide" style="animation-delay: 0.3s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500 font-mono">MALWARE DETECTED</span>
                    <svg class="w-5 h-5 text-cyber-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold" id="malwareDetected">0</p>
                <p class="text-xs text-cyber-purple mt-1" id="malwareTrend">↓ 0% vs last week</p>
            </div>
            
            <div class="cyber-border rounded-xl p-4 bg-cyber-card/50 backdrop-blur animate-slide" style="animation-delay: 0.4s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500 font-mono">PHISHING BLOCKED</span>
                    <svg class="w-5 h-5 text-cyber-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold" id="phishingBlocked">0</p>
                <p class="text-xs text-cyber-green mt-1" id="phishingTrend">↓ 0% vs last week</p>
            </div>
            
            <div class="cyber-border rounded-xl p-4 bg-cyber-card/50 backdrop-blur animate-slide" style="animation-delay: 0.5s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500 font-mono">AVG RESPONSE TIME</span>
                    <svg class="w-5 h-5 text-cyber-cyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold"><span id="avgResponse">0</span><span class="text-lg text-gray-500">ms</span></p>
                <p class="text-xs text-cyber-cyan mt-1">Within SLA targets</p>
            </div>
            
            <div class="cyber-border rounded-xl p-4 bg-cyber-card/50 backdrop-blur animate-slide" style="animation-delay: 0.6s">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-xs text-gray-500 font-mono">UPTIME</span>
                    <svg class="w-5 h-5 text-cyber-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <p class="text-3xl font-bold"><span id="uptime">99.97</span><span class="text-lg text-gray-500">%</span></p>
                <p class="text-xs text-cyber-green mt-1">30-day rolling average</p>
            </div>
        </div>
        
        <!-- Main Charts Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Attack Timeline Chart -->
            <div class="lg:col-span-2 cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">ATTACK TIMELINE</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Last 7 days activity correlation</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateTimelineRange('7d')" class="px-3 py-1 text-xs font-mono bg-cyber-cyan/20 text-cyber-cyan rounded border border-cyber-cyan/30 hover:bg-cyber-cyan/30 transition-colors">7D</button>
                        <button onclick="updateTimelineRange('30d')" class="px-3 py-1 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors">30D</button>
                        <button onclick="updateTimelineRange('90d')" class="px-3 py-1 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors">90D</button>
                    </div>
                </div>
                <div class="chart-container h-72">
                    <canvas id="timelineChart"></canvas>
                </div>
            </div>
            
            <!-- Attack Type Distribution -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">ATTACK DISTRIBUTION</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">By attack vector type</p>
                    </div>
                    <span class="px-2 py-1 text-xs font-mono bg-cyber-cyan/10 text-cyber-cyan rounded border border-cyber-cyan/20 animate-pulse-slow">
                        CLICK FOR DETAILS
                    </span>
                </div>
                <div class="chart-container h-56">
                    <canvas id="distributionChart"></canvas>
                </div>
                <div id="distributionLegend" class="mt-4 space-y-2"></div>
            </div>
        </div>
        
        <!-- Second Row -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <!-- Geographic Distribution -->
            <div class="lg:col-span-2 cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">GEOGRAPHIC ORIGIN</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Top source countries by attack volume</p>
                    </div>
                </div>
                <div id="geoList" class="space-y-3"></div>
            </div>
            
            <!-- DOS Event Analysis -->
            <div class="lg:col-span-2 cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">DOS EVENT ANALYSIS</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Bandwidth consumption over time</p>
                    </div>
                    <span class="px-3 py-1 text-xs font-mono bg-cyber-orange/20 text-cyber-orange rounded border border-cyber-orange/30">
                        CRITICAL MONITORING
                    </span>
                </div>
                <div class="chart-container h-48">
                    <canvas id="dosChart"></canvas>
                </div>
                <div class="grid grid-cols-3 gap-4 mt-4 pt-4 border-t border-cyber-border">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">PEAK BANDWIDTH</p>
                        <p class="text-xl font-bold text-cyber-orange" id="peakBandwidth">0 Gbps</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">AVG DURATION</p>
                        <p class="text-xl font-bold text-cyber-cyan" id="avgDuration">0 min</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">MITIGATED</p>
                        <p class="text-xl font-bold text-cyber-green" id="mitigatedRate">0%</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Third Row - Events & Correlation -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Live Attack Feed -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <span class="status-dot bg-cyber-red"></span>
                        <h3 class="font-display text-lg tracking-wider">LIVE THREAT FEED</h3>
                    </div>
                    <span class="text-xs text-gray-500 font-mono">AUTO-REFRESH 5s</span>
                </div>
                <div id="liveFeed" class="space-y-3 max-h-80 overflow-y-auto pr-2"></div>
            </div>
            
            <!-- Attack Correlation Matrix -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">CORRELATION INSIGHTS</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Attack pattern relationships</p>
                    </div>
                </div>
                <div id="correlationInsights" class="space-y-4"></div>
            </div>
            
            <!-- Time Pattern Analysis -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">HOURLY HEATMAP</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Attack frequency by hour (UTC)</p>
                    </div>
                </div>
                <div id="heatmapContainer" class="grid grid-cols-12 gap-1"></div>
                <div class="flex justify-between mt-4 text-xs text-gray-500 font-mono">
                    <span>00:00</span>
                    <span>06:00</span>
                    <span>12:00</span>
                    <span>18:00</span>
                    <span>23:00</span>
                </div>
                <div class="flex items-center justify-center gap-2 mt-3">
                    <span class="text-xs text-gray-500">Low</span>
                    <div class="flex gap-1">
                        <div class="w-4 h-3 bg-cyber-cyan/10 rounded-sm"></div>
                        <div class="w-4 h-3 bg-cyber-cyan/30 rounded-sm"></div>
                        <div class="w-4 h-3 bg-cyber-cyan/50 rounded-sm"></div>
                        <div class="w-4 h-3 bg-cyber-cyan/70 rounded-sm"></div>
                        <div class="w-4 h-3 bg-cyber-cyan rounded-sm"></div>
                    </div>
                    <span class="text-xs text-gray-500">High</span>
                </div>
            </div>
        </div>
        
        <!-- Story Section -->
        <div class="cyber-border rounded-xl p-6 bg-gradient-to-br from-cyber-card via-cyber-dark to-cyber-card">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyber-purple to-cyber-cyan flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="font-display text-xl tracking-wider">THREAT INTELLIGENCE SUMMARY</h3>
                    <p class="text-xs text-gray-500 font-mono">AI-Generated insights from pattern analysis</p>
                </div>
            </div>
            <div id="storySection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>
        
        <!-- New Charts Row - Decision Tree, Time Series, Waffle Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Decision Tree for Incident Response -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">INCIDENT RESPONSE TREE</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Automated decision workflow</p>
                    </div>
                    <span class="px-3 py-1 text-xs font-mono bg-cyber-green/20 text-cyber-green rounded border border-cyber-green/30">
                        ACTIVE
                    </span>
                </div>
                <div id="decisionTree" class="relative"></div>
                <div class="mt-4 pt-4 border-t border-cyber-border">
                    <div class="flex items-center justify-between text-xs">
                        <span class="text-gray-500 font-mono">DECISIONS TODAY</span>
                        <span class="text-cyber-cyan font-bold" id="decisionsToday">0</span>
                    </div>
                    <div class="flex items-center justify-between text-xs mt-2">
                        <span class="text-gray-500 font-mono">AUTO-RESOLVED</span>
                        <span class="text-cyber-green font-bold" id="autoResolved">0%</span>
                    </div>
                </div>
            </div>
            
            <!-- Time Series - Attack Prediction -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">ATTACK TREND FORECAST</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">ML-based prediction model</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-cyber-cyan animate-pulse"></span>
                        <span class="text-xs text-gray-400 font-mono">LIVE</span>
                    </div>
                </div>
                <div class="chart-container h-56">
                    <canvas id="timeSeriesChart"></canvas>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4 pt-4 border-t border-cyber-border">
                    <div>
                        <p class="text-xs text-gray-500 font-mono">FORECAST ACCURACY</p>
                        <p class="text-lg font-bold text-cyber-green" id="forecastAccuracy">94.2%</p>
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 font-mono">PREDICTED SPIKE</p>
                        <p class="text-lg font-bold text-cyber-orange" id="predictedSpike">+18% in 4h</p>
                    </div>
                </div>
            </div>
            
            <!-- Waffle Chart - Incident Response Status -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">RESPONSE STATUS</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Incident resolution breakdown</p>
                    </div>
                </div>
                <div id="waffleChart" class="grid grid-cols-10 gap-1 mb-4"></div>
                <div id="waffleLegend" class="space-y-2 mt-4 pt-4 border-t border-cyber-border"></div>
                <div class="mt-4 p-3 rounded-lg bg-cyber-dark/50 border border-cyber-border">
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-400">Mean Time to Resolution</span>
                        <span class="text-sm font-bold text-cyber-cyan" id="mttr">12.4 min</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Advanced Analytics Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Detailed Time Series with Anomaly Detection -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">ANOMALY DETECTION</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Real-time traffic analysis with ML anomaly scoring</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="updateAnomalyRange('1h')" class="px-3 py-1 text-xs font-mono bg-cyber-cyan/20 text-cyber-cyan rounded border border-cyber-cyan/30 hover:bg-cyber-cyan/30 transition-colors">1H</button>
                        <button onclick="updateAnomalyRange('6h')" class="px-3 py-1 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors">6H</button>
                        <button onclick="updateAnomalyRange('24h')" class="px-3 py-1 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors">24H</button>
                    </div>
                </div>
                <div class="chart-container h-64">
                    <canvas id="anomalyChart"></canvas>
                </div>
                <div class="grid grid-cols-4 gap-4 mt-4 pt-4 border-t border-cyber-border">
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">ANOMALIES</p>
                        <p class="text-xl font-bold text-cyber-red" id="anomalyCount">7</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">BASELINE</p>
                        <p class="text-xl font-bold text-cyber-cyan" id="baselineValue">1.2K/s</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">CURRENT</p>
                        <p class="text-xl font-bold text-cyber-orange" id="currentValue">1.8K/s</p>
                    </div>
                    <div class="text-center">
                        <p class="text-xs text-gray-500 font-mono">DEVIATION</p>
                        <p class="text-xl font-bold text-cyber-yellow" id="deviationValue">+50%</p>
                    </div>
                </div>
            </div>
            
            <!-- Response Workflow Decision Tree (Expanded) -->
            <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="font-display text-lg tracking-wider">RESPONSE WORKFLOW ENGINE</h3>
                        <p class="text-xs text-gray-500 font-mono mt-1">Automated incident classification & routing</p>
                    </div>
                    <span class="px-3 py-1 text-xs font-mono bg-cyber-purple/20 text-cyber-purple rounded border border-cyber-purple/30">
                        AI-POWERED
                    </span>
                </div>
                <div id="expandedDecisionTree" class="relative overflow-x-auto"></div>
            </div>
        </div>

        <!-- Recent Incidents Table -->
        <div class="cyber-border rounded-xl p-6 bg-cyber-card/50 backdrop-blur overflow-hidden">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="font-display text-lg tracking-wider">RECENT SECURITY INCIDENTS</h3>
                    <p class="text-xs text-gray-500 font-mono mt-1">Last 20 recorded events with full attribution • <span class="text-cyber-cyan">Click row for details</span></p>
                </div>
                <div class="flex gap-4">
                    <select id="severityFilter" class="bg-cyber-dark border border-cyber-border rounded px-3 py-1 text-sm font-mono focus:outline-none focus:border-cyber-cyan" onchange="filterIncidents()">
                        <option value="all">All Severity</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                    <select id="typeFilter" class="bg-cyber-dark border border-cyber-border rounded px-3 py-1 text-sm font-mono focus:outline-none focus:border-cyber-cyan" onchange="filterIncidents()">
                        <option value="all">All Types</option>
                        <option value="ddos">DDoS</option>
                        <option value="malware">Malware</option>
                        <option value="phishing">Phishing</option>
                        <option value="ransomware">Ransomware</option>
                        <option value="injection">SQL Injection</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="text-left text-xs text-gray-500 font-mono border-b border-cyber-border">
                            <th class="pb-3 pr-4">TIMESTAMP</th>
                            <th class="pb-3 pr-4">EVENT ID</th>
                            <th class="pb-3 pr-4">TYPE</th>
                            <th class="pb-3 pr-4">SOURCE</th>
                            <th class="pb-3 pr-4">TARGET</th>
                            <th class="pb-3 pr-4">SEVERITY</th>
                            <th class="pb-3 pr-4">STATUS</th>
                            <th class="pb-3">DETAILS</th>
                        </tr>
                    </thead>
                    <tbody id="incidentsTable" class="text-sm"></tbody>
                </table>
            </div>
        </div>
        
        <!-- Global Threat Map Section -->
        <div class="cyber-border rounded-xl bg-cyber-card/50 backdrop-blur overflow-hidden">
            <div class="p-6 border-b border-cyber-border">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-cyber-red to-cyber-orange flex items-center justify-center">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-display text-xl tracking-wider">GLOBAL THREAT MAP</h3>
                            <p class="text-xs text-gray-500 font-mono mt-1">Real-time visualization of cyber attacks worldwide • <span class="text-cyber-cyan">Click markers for incident details</span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-cyber-red animate-pulse"></span>
                                <span class="text-xs text-gray-400">Critical</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-cyber-orange"></span>
                                <span class="text-xs text-gray-400">High</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-cyber-yellow"></span>
                                <span class="text-xs text-gray-400">Medium</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="w-3 h-3 rounded-full bg-cyber-cyan"></span>
                                <span class="text-xs text-gray-400">Low</span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="refreshMapIncidents()" class="px-3 py-1.5 text-xs font-mono bg-cyber-cyan/20 text-cyber-cyan rounded border border-cyber-cyan/30 hover:bg-cyber-cyan/30 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                                </svg>
                                REFRESH
                            </button>
                            <button onclick="toggleHeatmap()" id="heatmapToggle" class="px-3 py-1.5 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors">
                                HEATMAP
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Map Stats Bar -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 p-4 bg-cyber-dark/50 border-b border-cyber-border">
                <div class="text-center">
                    <p class="text-xs text-gray-500 font-mono">LIVE ATTACKS</p>
                    <p class="text-xl font-bold text-cyber-red" id="mapLiveAttacks">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 font-mono">COUNTRIES AFFECTED</p>
                    <p class="text-xl font-bold text-cyber-orange" id="mapCountries">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 font-mono">TOP SOURCE</p>
                    <p class="text-xl font-bold text-cyber-yellow" id="mapTopSource">--</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 font-mono">TOP TARGET</p>
                    <p class="text-xl font-bold text-cyber-cyan" id="mapTopTarget">--</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 font-mono">ATTACK RATE</p>
                    <p class="text-xl font-bold text-cyber-purple" id="mapAttackRate">0/min</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-500 font-mono">BLOCKED</p>
                    <p class="text-xl font-bold text-cyber-green" id="mapBlocked">0%</p>
                </div>
            </div>
            
            <!-- The Map -->
            <div id="threatMap" class="h-[500px] lg:h-[600px] relative">
                <!-- Map will be initialized here -->
                <div id="mapLoading" class="absolute inset-0 flex items-center justify-center bg-cyber-dark/80 z-[1000]">
                    <div class="text-center">
                        <div class="w-16 h-16 border-4 border-cyber-cyan/30 border-t-cyber-cyan rounded-full animate-spin mx-auto mb-4"></div>
                        <p class="text-sm text-gray-400 font-mono">LOADING THREAT DATA...</p>
                    </div>
                </div>
            </div>
            
            <!-- Recent Map Events -->
            <div class="p-4 bg-cyber-dark/50 border-t border-cyber-border">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-mono text-gray-400">RECENT MAP EVENTS</h4>
                    <span class="text-xs text-gray-500 font-mono">Auto-updating</span>
                </div>
                <div id="mapEventsFeed" class="flex gap-3 overflow-x-auto pb-2">
                    <!-- Events will be populated here -->
                </div>
            </div>
        </div>
        
    </main>
    
    <!-- Footer -->
    <footer class="relative z-10 border-t border-cyber-border bg-cyber-dark/80 backdrop-blur-xl mt-8">
        <div class="max-w-[1920px] mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <p class="text-xs text-gray-500 font-mono">© 2024 CYBERSHIELD ANALYTICS • THREAT INTELLIGENCE PLATFORM</p>
                <div class="flex items-center gap-4">
                    <span class="text-xs text-gray-500 font-mono">DATA REFRESH: <span class="text-cyber-cyan" id="refreshRate">5s</span></span>
                    <span class="text-xs text-gray-500 font-mono">NODES: <span class="text-cyber-green">24/24 ONLINE</span></span>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Modal Overlay -->
    <div id="modalOverlay" class="modal-overlay" onclick="closeModal()"></div>
    
    <!-- Detail Modal -->
    <div id="detailModal" class="modal-container">
        <div class="cyber-border rounded-2xl bg-cyber-card modal-glow overflow-hidden">
            <!-- Modal Header -->
            <div class="relative p-6 border-b border-cyber-border bg-gradient-to-r from-cyber-dark via-cyber-card to-cyber-dark">
                <button onclick="closeModal()" class="absolute top-4 right-4 w-10 h-10 rounded-lg bg-cyber-dark/50 border border-cyber-border flex items-center justify-center hover:border-cyber-red hover:text-cyber-red transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="flex items-center gap-4">
                    <div id="modalIcon" class="w-14 h-14 rounded-xl flex items-center justify-center modal-pulse">
                        <!-- Icon inserted dynamically -->
                    </div>
                    <div>
                        <p class="text-xs text-gray-500 font-mono tracking-wider">ATTACK VECTOR ANALYSIS</p>
                        <h2 id="modalTitle" class="font-display text-2xl tracking-wider mt-1">Loading...</h2>
                    </div>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 space-y-6">
                <!-- Quick Stats Row -->
                <div id="modalStats" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <!-- Stats inserted dynamically -->
                </div>
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Trend Chart -->
                    <div class="cyber-border rounded-xl p-4 bg-cyber-dark/50">
                        <h3 class="text-sm font-mono text-gray-400 mb-4">24-HOUR TREND</h3>
                        <div class="h-48">
                            <canvas id="modalTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Severity Breakdown -->
                    <div class="cyber-border rounded-xl p-4 bg-cyber-dark/50">
                        <h3 class="text-sm font-mono text-gray-400 mb-4">SEVERITY BREAKDOWN</h3>
                        <div class="h-48">
                            <canvas id="modalSeverityChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Details Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Top Sources -->
                    <div class="cyber-border rounded-xl p-4 bg-cyber-dark/50 detail-card">
                        <h3 class="text-sm font-mono text-gray-400 mb-4">TOP SOURCE COUNTRIES</h3>
                        <div id="modalSources" class="space-y-3">
                            <!-- Sources inserted dynamically -->
                        </div>
                    </div>
                    
                    <!-- Targeted Systems -->
                    <div class="cyber-border rounded-xl p-4 bg-cyber-dark/50 detail-card">
                        <h3 class="text-sm font-mono text-gray-400 mb-4">TARGETED SYSTEMS</h3>
                        <div id="modalTargets" class="space-y-3">
                            <!-- Targets inserted dynamically -->
                        </div>
                    </div>
                    
                    <!-- Attack Signatures -->
                    <div class="cyber-border rounded-xl p-4 bg-cyber-dark/50 detail-card">
                        <h3 class="text-sm font-mono text-gray-400 mb-4">COMMON SIGNATURES</h3>
                        <div id="modalSignatures" class="space-y-2">
                            <!-- Signatures inserted dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Recent Incidents Table -->
                <div class="cyber-border rounded-xl p-4 bg-cyber-dark/50">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-sm font-mono text-gray-400">RECENT INCIDENTS</h3>
                        <span id="modalIncidentCount" class="text-xs font-mono text-cyber-cyan">0 incidents</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-xs text-gray-500 font-mono border-b border-cyber-border">
                                    <th class="pb-2 pr-4">TIME</th>
                                    <th class="pb-2 pr-4">SOURCE</th>
                                    <th class="pb-2 pr-4">TARGET</th>
                                    <th class="pb-2 pr-4">SEVERITY</th>
                                    <th class="pb-2">STATUS</th>
                                </tr>
                            </thead>
                            <tbody id="modalIncidents" class="text-sm">
                                <!-- Incidents inserted dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div id="modalRecommendations" class="cyber-border rounded-xl p-4 bg-gradient-to-r from-cyber-purple/10 to-cyber-cyan/10 border-cyber-purple/30">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-cyber-purple/20 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-cyber-purple" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-semibold text-white mb-1">AI Recommendation</h4>
                            <p id="modalRecommendationText" class="text-sm text-gray-400">Loading recommendation...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ================================
        // DATA GENERATION & CONFIGURATION
        // ================================
        
        const attackTypes = ['DDoS', 'Malware', 'Phishing', 'Ransomware', 'SQL Injection', 'XSS', 'Brute Force', 'Zero-Day'];
        const countries = [
            { code: 'CN', name: 'China', flag: '🇨🇳', lat: 35.8617, lng: 104.1954 },
            { code: 'RU', name: 'Russia', flag: '🇷🇺', lat: 61.5240, lng: 105.3188 },
            { code: 'US', name: 'United States', flag: '🇺🇸', lat: 37.0902, lng: -95.7129 },
            { code: 'KP', name: 'North Korea', flag: '🇰🇵', lat: 40.3399, lng: 127.5101 },
            { code: 'IR', name: 'Iran', flag: '🇮🇷', lat: 32.4279, lng: 53.6880 },
            { code: 'BR', name: 'Brazil', flag: '🇧🇷', lat: -14.2350, lng: -51.9253 },
            { code: 'IN', name: 'India', flag: '🇮🇳', lat: 20.5937, lng: 78.9629 },
            { code: 'VN', name: 'Vietnam', flag: '🇻🇳', lat: 14.0583, lng: 108.2772 },
            { code: 'ID', name: 'Indonesia', flag: '🇮🇩', lat: -0.7893, lng: 113.9213 },
            { code: 'UA', name: 'Ukraine', flag: '🇺🇦', lat: 48.3794, lng: 31.1656 },
            { code: 'DE', name: 'Germany', flag: '🇩🇪', lat: 51.1657, lng: 10.4515 },
            { code: 'GB', name: 'United Kingdom', flag: '🇬🇧', lat: 55.3781, lng: -3.4360 },
            { code: 'FR', name: 'France', flag: '🇫🇷', lat: 46.2276, lng: 2.2137 },
            { code: 'JP', name: 'Japan', flag: '🇯🇵', lat: 36.2048, lng: 138.2529 },
            { code: 'KR', name: 'South Korea', flag: '🇰🇷', lat: 35.9078, lng: 127.7669 },
            { code: 'AU', name: 'Australia', flag: '🇦🇺', lat: -25.2744, lng: 133.7751 },
            { code: 'NL', name: 'Netherlands', flag: '🇳🇱', lat: 52.1326, lng: 5.2913 },
            { code: 'PL', name: 'Poland', flag: '🇵🇱', lat: 51.9194, lng: 19.1451 },
            { code: 'SG', name: 'Singapore', flag: '🇸🇬', lat: 1.3521, lng: 103.8198 },
            { code: 'CA', name: 'Canada', flag: '🇨🇦', lat: 56.1304, lng: -106.3468 }
        ];
        
        // Target locations (data centers, cities)
        const targetLocations = [
            { name: 'New York DC', lat: 40.7128, lng: -74.0060, country: 'US' },
            { name: 'London DC', lat: 51.5074, lng: -0.1278, country: 'GB' },
            { name: 'Frankfurt DC', lat: 50.1109, lng: 8.6821, country: 'DE' },
            { name: 'Singapore DC', lat: 1.3521, lng: 103.8198, country: 'SG' },
            { name: 'Tokyo DC', lat: 35.6762, lng: 139.6503, country: 'JP' },
            { name: 'Sydney DC', lat: -33.8688, lng: 151.2093, country: 'AU' },
            { name: 'São Paulo DC', lat: -23.5505, lng: -46.6333, country: 'BR' },
            { name: 'Amsterdam DC', lat: 52.3676, lng: 4.9041, country: 'NL' },
            { name: 'Mumbai DC', lat: 19.0760, lng: 72.8777, country: 'IN' },
            { name: 'Toronto DC', lat: 43.6532, lng: -79.3832, country: 'CA' }
        ];
        const severityLevels = ['critical', 'high', 'medium', 'low'];
        const targets = ['Web Server', 'Database', 'API Gateway', 'Auth Service', 'CDN', 'Email Server', 'DNS', 'Firewall'];
        
        let allIncidents = [];
        let charts = {};
        let modalCharts = {};
        
        // Attack type detailed info
        const attackTypeDetails = {
            'DDoS': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>`,
                color: '#ff9500',
                signatures: ['SYN Flood', 'UDP Amplification', 'HTTP GET Flood', 'Slowloris', 'DNS Amplification', 'NTP Reflection'],
                recommendation: 'Implement rate limiting on edge servers and consider upgrading DDoS mitigation capacity. Current attack patterns suggest botnet coordination - recommend threat intel sharing with industry peers.'
            },
            'Malware': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`,
                color: '#a855f7',
                signatures: ['Trojan.GenericKD', 'Emotet Variant', 'Cobalt Strike Beacon', 'Mimikatz Activity', 'PowerShell Empire', 'Metasploit Payload'],
                recommendation: 'Update endpoint detection rules and increase behavioral analysis sensitivity. Consider implementing application whitelisting on critical systems.'
            },
            'Phishing': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>`,
                color: '#ffea00',
                signatures: ['Credential Harvesting', 'O365 Impersonation', 'CEO Fraud BEC', 'Invoice Scam', 'Account Verification', 'Password Reset Lure'],
                recommendation: 'Deploy AI-based email filtering and increase user awareness training frequency. Recent campaigns show improved social engineering - update detection signatures.'
            },
            'Ransomware': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/></svg>`,
                color: '#ff3366',
                signatures: ['LockBit 3.0', 'BlackCat/ALPHV', 'Royal Ransomware', 'Play Ransomware', 'Clop Variant', 'Hive Legacy'],
                recommendation: 'CRITICAL: Verify offline backup integrity immediately. Implement network segmentation to limit lateral movement. Review privileged access management policies.'
            },
            'SQL Injection': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"/></svg>`,
                color: '#00f0ff',
                signatures: ['Union-based SQLi', 'Blind SQLi', 'Time-based SQLi', 'Error-based SQLi', 'Second Order SQLi', 'Out-of-band SQLi'],
                recommendation: 'Audit all database queries for parameterized statements. Deploy WAF rules targeting SQLi patterns. Review database user permissions and implement least privilege.'
            },
            'XSS': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>`,
                color: '#00ff88',
                signatures: ['Reflected XSS', 'Stored XSS', 'DOM-based XSS', 'Self-XSS', 'mXSS Mutation', 'Polyglot Payload'],
                recommendation: 'Implement Content Security Policy headers and review output encoding practices. Consider deploying client-side XSS protection libraries.'
            },
            'Brute Force': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>`,
                color: '#ff6b6b',
                signatures: ['SSH Bruteforce', 'RDP Attack', 'Web Login Attack', 'API Key Guessing', 'Credential Stuffing', 'Password Spraying'],
                recommendation: 'Implement account lockout policies and deploy CAPTCHA on authentication endpoints. Consider implementing hardware security keys for privileged accounts.'
            },
            'Zero-Day': {
                icon: `<svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
                color: '#ff00ff',
                signatures: ['Unknown Exploit', 'Novel Attack Vector', 'Unpatched Vuln', 'CVE Pending', 'Behavior Anomaly', 'Sandbox Evasion'],
                recommendation: 'URGENT: Isolate affected systems immediately. Engage incident response team and consider external forensic analysis. Document all indicators of compromise for threat sharing.'
            }
        };
        
        // Generate random number within range
        function rand(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // Generate realistic IP address
        function generateIP() {
            return `${rand(1, 255)}.${rand(0, 255)}.${rand(0, 255)}.${rand(1, 254)}`;
        }
        
        // Generate event ID
        function generateEventID() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let id = 'EVT-';
            for (let i = 0; i < 8; i++) id += chars[rand(0, chars.length - 1)];
            return id;
        }
        
        // Color mapping
        const severityColors = {
            critical: { bg: 'bg-cyber-red/20', text: 'text-cyber-red', border: 'border-cyber-red/30' },
            high: { bg: 'bg-cyber-orange/20', text: 'text-cyber-orange', border: 'border-cyber-orange/30' },
            medium: { bg: 'bg-cyber-yellow/20', text: 'text-cyber-yellow', border: 'border-cyber-yellow/30' },
            low: { bg: 'bg-cyber-cyan/20', text: 'text-cyber-cyan', border: 'border-cyber-cyan/30' }
        };
        
        const typeColors = {
            'DDoS': '#ff9500',
            'Malware': '#a855f7',
            'Phishing': '#ffea00',
            'Ransomware': '#ff3366',
            'SQL Injection': '#00f0ff',
            'XSS': '#00ff88',
            'Brute Force': '#ff6b6b',
            'Zero-Day': '#ff00ff'
        };
        
        // ================================
        // CHART INITIALIZATION
        // ================================
        
        function initCharts() {
            // Timeline Chart
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            charts.timeline = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'DDoS Attacks',
                            data: [],
                            borderColor: '#ff9500',
                            backgroundColor: 'rgba(255, 149, 0, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Malware',
                            data: [],
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Phishing',
                            data: [],
                            borderColor: '#ffea00',
                            backgroundColor: 'rgba(255, 234, 0, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Other',
                            data: [],
                            borderColor: '#00f0ff',
                            backgroundColor: 'rgba(0, 240, 255, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#9ca3af',
                                font: { family: 'JetBrains Mono', size: 10 },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1,
                            titleFont: { family: 'JetBrains Mono' },
                            bodyFont: { family: 'Space Grotesk' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(30, 58, 95, 0.3)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 10 } }
                        },
                        y: {
                            grid: { color: 'rgba(30, 58, 95, 0.3)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 10 } }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
            
            // Distribution Chart (Doughnut)
            const distributionCtx = document.getElementById('distributionChart').getContext('2d');
            charts.distribution = new Chart(distributionCtx, {
                type: 'doughnut',
                data: {
                    labels: attackTypes,
                    datasets: [{
                        data: [],
                        backgroundColor: Object.values(typeColors),
                        borderColor: '#111827',
                        borderWidth: 2,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw.toLocaleString()} (${percentage}%)`;
                                },
                                afterLabel: function() {
                                    return 'Click for details →';
                                }
                            }
                        }
                    },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const attackType = attackTypes[index];
                            const count = charts.distribution.data.datasets[0].data[index];
                            openModal(attackType, { count });
                        }
                    },
                    onHover: (event, elements) => {
                        event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
            
            // DOS Chart (Area)
            const dosCtx = document.getElementById('dosChart').getContext('2d');
            charts.dos = new Chart(dosCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Bandwidth (Gbps)',
                        data: [],
                        borderColor: '#ff9500',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                            gradient.addColorStop(0, 'rgba(255, 149, 0, 0.4)');
                            gradient.addColorStop(1, 'rgba(255, 149, 0, 0)');
                            return gradient;
                        },
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 9 }, maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: 'rgba(30, 58, 95, 0.3)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 9 } }
                        }
                    }
                }
            });
            
            // Time Series Forecast Chart
            const timeSeriesCtx = document.getElementById('timeSeriesChart').getContext('2d');
            charts.timeSeries = new Chart(timeSeriesCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Actual',
                            data: [],
                            borderColor: '#00f0ff',
                            backgroundColor: 'rgba(0, 240, 255, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Predicted',
                            data: [],
                            borderColor: '#a855f7',
                            borderDash: [5, 5],
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Upper Bound',
                            data: [],
                            borderColor: 'rgba(255, 234, 0, 0.3)',
                            backgroundColor: 'transparent',
                            borderDash: [2, 2],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        },
                        {
                            label: 'Lower Bound',
                            data: [],
                            borderColor: 'rgba(255, 234, 0, 0.3)',
                            backgroundColor: 'transparent',
                            borderDash: [2, 2],
                            fill: false,
                            tension: 0.3,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#9ca3af',
                                font: { family: 'JetBrains Mono', size: 9 },
                                usePointStyle: true,
                                padding: 15,
                                filter: (item) => item.datasetIndex < 2
                            }
                        },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(30, 58, 95, 0.2)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 9 }, maxTicksLimit: 6 }
                        },
                        y: {
                            grid: { color: 'rgba(30, 58, 95, 0.2)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 9 } }
                        }
                    }
                }
            });
            
            // Anomaly Detection Chart
            const anomalyCtx = document.getElementById('anomalyChart').getContext('2d');
            charts.anomaly = new Chart(anomalyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Traffic',
                            data: [],
                            borderColor: '#00f0ff',
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                                gradient.addColorStop(0, 'rgba(0, 240, 255, 0.3)');
                                gradient.addColorStop(1, 'rgba(0, 240, 255, 0)');
                                return gradient;
                            },
                            fill: true,
                            tension: 0.4,
                            pointRadius: 0
                        },
                        {
                            label: 'Baseline',
                            data: [],
                            borderColor: '#00ff88',
                            borderDash: [10, 5],
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0,
                            pointRadius: 0
                        },
                        {
                            label: 'Threshold',
                            data: [],
                            borderColor: '#ff3366',
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0,
                            pointRadius: 0
                        },
                        {
                            label: 'Anomalies',
                            data: [],
                            borderColor: '#ff3366',
                            backgroundColor: '#ff3366',
                            fill: false,
                            showLine: false,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            pointStyle: 'triangle'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#9ca3af',
                                font: { family: 'JetBrains Mono', size: 9 },
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 3 && context.raw !== null) {
                                        return `⚠️ Anomaly Detected: ${context.raw} req/s`;
                                    }
                                    return `${context.dataset.label}: ${context.raw} req/s`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(30, 58, 95, 0.2)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 9 }, maxTicksLimit: 10 }
                        },
                        y: {
                            grid: { color: 'rgba(30, 58, 95, 0.2)' },
                            ticks: { color: '#6b7280', font: { family: 'JetBrains Mono', size: 9 } }
                        }
                    }
                }
            });
        }
        
        // ================================
        // DATA UPDATE FUNCTIONS
        // ================================
        
        function updateKPIs() {
            const totalAttacks = rand(45000, 52000);
            const dosEvents = rand(1200, 1800);
            const malware = rand(3500, 4500);
            const phishing = rand(8000, 12000);
            
            animateNumber('totalAttacks', totalAttacks);
            animateNumber('dosEvents', dosEvents);
            animateNumber('malwareDetected', malware);
            animateNumber('phishingBlocked', phishing);
            animateNumber('blockedToday', rand(15000, 25000));
            animateNumber('activeIncidents', rand(3, 12));
            animateNumber('systemsProtected', 847);
            animateNumber('avgResponse', rand(12, 28));
            
            document.getElementById('attacksTrend').textContent = `↑ ${rand(5, 15)}% vs last week`;
            document.getElementById('dosTrend').textContent = `↑ ${rand(8, 25)}% vs last week`;
            document.getElementById('malwareTrend').textContent = `↓ ${rand(3, 10)}% vs last week`;
            document.getElementById('phishingTrend').textContent = `↓ ${rand(2, 8)}% vs last week`;
        }
        
        function animateNumber(elementId, target) {
            const element = document.getElementById(elementId);
            const start = parseInt(element.textContent.replace(/,/g, '')) || 0;
            const duration = 1000;
            const startTime = performance.now();
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * easeProgress);
                element.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            requestAnimationFrame(update);
        }
        
        function updateTimelineChart() {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            charts.timeline.data.labels = days;
            
            // Generate correlated data - DDoS spikes on weekends, malware mid-week
            const ddos = days.map((_, i) => {
                const base = rand(150, 250);
                const weekendBonus = (i >= 5) ? rand(100, 200) : 0;
                return base + weekendBonus;
            });
            
            const malware = days.map((_, i) => {
                const base = rand(80, 150);
                const midWeekBonus = (i >= 2 && i <= 4) ? rand(50, 100) : 0;
                return base + midWeekBonus;
            });
            
            const phishing = days.map((_, i) => {
                const base = rand(100, 180);
                const mondayBonus = (i === 0) ? rand(80, 150) : 0;
                return base + mondayBonus;
            });
            
            const other = days.map(() => rand(50, 120));
            
            charts.timeline.data.datasets[0].data = ddos;
            charts.timeline.data.datasets[1].data = malware;
            charts.timeline.data.datasets[2].data = phishing;
            charts.timeline.data.datasets[3].data = other;
            charts.timeline.update('none');
        }
        
        function updateDistributionChart() {
            const data = attackTypes.map(() => rand(500, 3000));
            charts.distribution.data.datasets[0].data = data;
            charts.distribution.update('none');
            
            // Update legend
            const legendContainer = document.getElementById('distributionLegend');
            const total = data.reduce((a, b) => a + b, 0);
            legendContainer.innerHTML = attackTypes.map((type, i) => {
                const percentage = ((data[i] / total) * 100).toFixed(1);
                return `
                    <div class="flex items-center justify-between text-sm cursor-pointer hover:bg-cyber-border/20 rounded px-2 py-1 -mx-2 transition-colors" onclick="openModal('${type}', { count: ${data[i]} })">
                        <div class="flex items-center gap-2">
                            <div class="w-3 h-3 rounded-full" style="background: ${Object.values(typeColors)[i]}"></div>
                            <span class="text-gray-400">${type}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-white">${percentage}%</span>
                            <svg class="w-3 h-3 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateDOSChart() {
            const hours = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
            charts.dos.data.labels = hours;
            
            // Simulate DOS attack patterns with spikes
            const data = hours.map((_, i) => {
                let base = rand(5, 15);
                // Add attack spikes
                if (i === 3 || i === 4) base += rand(30, 60);
                if (i === 14 || i === 15) base += rand(20, 40);
                return base;
            });
            
            charts.dos.data.datasets[0].data = data;
            charts.dos.update('none');
            
            // Update DOS metrics
            document.getElementById('peakBandwidth').textContent = `${Math.max(...data)} Gbps`;
            document.getElementById('avgDuration').textContent = `${rand(8, 25)} min`;
            document.getElementById('mitigatedRate').textContent = `${rand(94, 99)}%`;
        }
        
        function updateGeoList() {
            const geoData = countries.map(country => ({
                ...country,
                attacks: rand(1000, 15000),
                change: rand(-20, 40)
            })).sort((a, b) => b.attacks - a.attacks).slice(0, 8);
            
            const maxAttacks = Math.max(...geoData.map(d => d.attacks));
            
            const container = document.getElementById('geoList');
            container.innerHTML = geoData.map((country, i) => {
                const percentage = (country.attacks / maxAttacks * 100).toFixed(0);
                const changeClass = country.change > 0 ? 'text-cyber-red' : 'text-cyber-green';
                const changeIcon = country.change > 0 ? '↑' : '↓';
                
                return `
                    <div class="animate-slide" style="animation-delay: ${i * 0.1}s">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <span class="text-lg">${country.flag}</span>
                                <span class="text-sm text-gray-300">${country.name}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-mono text-sm">${country.attacks.toLocaleString()}</span>
                                <span class="${changeClass} text-xs font-mono">${changeIcon}${Math.abs(country.change)}%</span>
                            </div>
                        </div>
                        <div class="h-2 bg-cyber-dark rounded-full overflow-hidden">
                            <div class="threat-bar h-full rounded-full bg-gradient-to-r from-cyber-cyan to-cyber-purple transition-all duration-1000" 
                                 style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateLiveFeed() {
            const container = document.getElementById('liveFeed');
            const newEvent = generateIncident();
            
            const eventHTML = `
                <div class="animate-slide p-3 rounded-lg border ${severityColors[newEvent.severity].border} ${severityColors[newEvent.severity].bg} cursor-pointer hover:scale-[1.02] transition-transform"
                     onclick="openModal('${newEvent.type}', { count: ${rand(500, 2000)} })">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center gap-2">
                            <span class="status-dot ${newEvent.severity === 'critical' ? 'bg-cyber-red' : newEvent.severity === 'high' ? 'bg-cyber-orange' : 'bg-cyber-yellow'}"></span>
                            <span class="text-xs font-mono text-gray-400">${newEvent.timestamp}</span>
                        </div>
                        <span class="text-xs font-mono ${severityColors[newEvent.severity].text}">${newEvent.severity.toUpperCase()}</span>
                    </div>
                    <p class="text-sm mt-2 text-white">${newEvent.type} detected from ${newEvent.source}</p>
                    <p class="text-xs text-gray-500 mt-1">Target: ${newEvent.target}</p>
                </div>
            `;
            
            container.insertAdjacentHTML('afterbegin', eventHTML);
            
            // Keep only last 10 events
            while (container.children.length > 10) {
                container.removeChild(container.lastChild);
            }
        }
        
        function updateHeatmap() {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            // Generate 24 hours x 7 days heatmap
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 24; hour++) {
                    let intensity = Math.random();
                    // Increase intensity during business hours for certain patterns
                    if (hour >= 9 && hour <= 17) intensity += 0.2;
                    // Night-time attack spikes
                    if (hour >= 1 && hour <= 4) intensity += Math.random() * 0.3;
                    
                    intensity = Math.min(intensity, 1);
                    
                    const cell = document.createElement('div');
                    cell.className = 'h-3 rounded-sm transition-all hover:scale-150 cursor-pointer';
                    cell.style.backgroundColor = `rgba(0, 240, 255, ${intensity})`;
                    cell.title = `Day ${day + 1}, ${hour}:00 - Intensity: ${(intensity * 100).toFixed(0)}%`;
                    container.appendChild(cell);
                }
            }
        }
        
        function updateCorrelationInsights() {
            const insights = [
                {
                    title: 'DDoS & Weekend Correlation',
                    description: 'DDoS attacks increase 47% on weekends when security teams are reduced.',
                    confidence: 94,
                    trend: 'up'
                },
                {
                    title: 'Phishing Monday Spike',
                    description: 'Phishing attempts peak on Mondays as employees return to work.',
                    confidence: 89,
                    trend: 'up'
                },
                {
                    title: 'Geographic Pattern',
                    description: 'Coordinated attacks from Eastern Europe during US nighttime hours.',
                    confidence: 78,
                    trend: 'stable'
                },
                {
                    title: 'Ransomware & Holidays',
                    description: 'Ransomware deployment correlates with major holiday periods.',
                    confidence: 85,
                    trend: 'up'
                }
            ];
            
            const container = document.getElementById('correlationInsights');
            container.innerHTML = insights.map(insight => `
                <div class="p-3 rounded-lg bg-cyber-dark/50 border border-cyber-border">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-semibold text-white">${insight.title}</h4>
                        <span class="text-xs font-mono ${insight.confidence > 85 ? 'text-cyber-green' : 'text-cyber-yellow'}">${insight.confidence}%</span>
                    </div>
                    <p class="text-xs text-gray-400">${insight.description}</p>
                </div>
            `).join('');
        }
        
        function updateDecisionTree() {
            const container = document.getElementById('decisionTree');
            const decisions = rand(1200, 2500);
            const autoResolve = rand(78, 92);
            
            document.getElementById('decisionsToday').textContent = decisions.toLocaleString();
            document.getElementById('autoResolved').textContent = `${autoResolve}%`;
            
            container.innerHTML = `
                <div class="flex flex-col items-center">
                    <!-- Root Node -->
                    <div class="relative">
                        <div class="w-32 py-2 px-3 bg-cyber-cyan/20 border border-cyber-cyan/50 rounded-lg text-center">
                            <p class="text-xs font-mono text-cyber-cyan">INCIDENT</p>
                            <p class="text-xs text-gray-400">Detected</p>
                        </div>
                        <div class="absolute left-1/2 bottom-0 w-px h-4 bg-cyber-border transform translate-y-full -translate-x-1/2"></div>
                    </div>
                    
                    <!-- Level 1 -->
                    <div class="mt-4 relative">
                        <div class="w-36 py-2 px-3 bg-cyber-purple/20 border border-cyber-purple/50 rounded-lg text-center">
                            <p class="text-xs font-mono text-cyber-purple">CLASSIFY</p>
                            <p class="text-xs text-gray-400">Severity Check</p>
                        </div>
                        <div class="absolute left-1/2 bottom-0 w-px h-4 bg-cyber-border transform translate-y-full -translate-x-1/2"></div>
                    </div>
                    
                    <!-- Branch -->
                    <div class="mt-4 flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-24 py-2 px-2 bg-cyber-red/20 border border-cyber-red/50 rounded-lg text-center">
                                <p class="text-[10px] font-mono text-cyber-red">CRITICAL</p>
                                <p class="text-xs text-white font-bold">${rand(5, 15)}%</p>
                            </div>
                            <div class="w-px h-3 bg-cyber-border"></div>
                            <div class="w-20 py-1 px-2 bg-cyber-orange/20 border border-cyber-orange/50 rounded text-center">
                                <p class="text-[9px] font-mono text-cyber-orange">ESCALATE</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-24 py-2 px-2 bg-cyber-yellow/20 border border-cyber-yellow/50 rounded-lg text-center">
                                <p class="text-[10px] font-mono text-cyber-yellow">HIGH</p>
                                <p class="text-xs text-white font-bold">${rand(20, 30)}%</p>
                            </div>
                            <div class="w-px h-3 bg-cyber-border"></div>
                            <div class="w-20 py-1 px-2 bg-cyber-cyan/20 border border-cyber-cyan/50 rounded text-center">
                                <p class="text-[9px] font-mono text-cyber-cyan">ANALYZE</p>
                            </div>
                        </div>
                        <div class="flex flex-col items-center">
                            <div class="w-24 py-2 px-2 bg-cyber-green/20 border border-cyber-green/50 rounded-lg text-center">
                                <p class="text-[10px] font-mono text-cyber-green">LOW/MED</p>
                                <p class="text-xs text-white font-bold">${rand(55, 70)}%</p>
                            </div>
                            <div class="w-px h-3 bg-cyber-border"></div>
                            <div class="w-20 py-1 px-2 bg-cyber-green/20 border border-cyber-green/50 rounded text-center">
                                <p class="text-[9px] font-mono text-cyber-green">AUTO-FIX</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateExpandedDecisionTree() {
            const container = document.getElementById('expandedDecisionTree');
            
            container.innerHTML = `
                <div class="flex justify-center pb-4" style="min-width: 600px;">
                    <svg width="600" height="320" class="overflow-visible">
                        <!-- Connection Lines -->
                        <defs>
                            <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#00f0ff;stop-opacity:0.8" />
                                <stop offset="100%" style="stop-color:#a855f7;stop-opacity:0.8" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        
                        <!-- Level 0 to Level 1 -->
                        <line x1="300" y1="40" x2="150" y2="100" stroke="url(#lineGradient)" stroke-width="2" filter="url(#glow)"/>
                        <line x1="300" y1="40" x2="450" y2="100" stroke="url(#lineGradient)" stroke-width="2" filter="url(#glow)"/>
                        
                        <!-- Level 1 to Level 2 (Left branch) -->
                        <line x1="150" y1="130" x2="75" y2="190" stroke="#ff3366" stroke-width="2" opacity="0.7"/>
                        <line x1="150" y1="130" x2="225" y2="190" stroke="#ffea00" stroke-width="2" opacity="0.7"/>
                        
                        <!-- Level 1 to Level 2 (Right branch) -->
                        <line x1="450" y1="130" x2="375" y2="190" stroke="#ff9500" stroke-width="2" opacity="0.7"/>
                        <line x1="450" y1="130" x2="525" y2="190" stroke="#00ff88" stroke-width="2" opacity="0.7"/>
                        
                        <!-- Level 2 to Level 3 -->
                        <line x1="75" y1="220" x2="75" y2="270" stroke="#ff3366" stroke-width="1.5" opacity="0.5"/>
                        <line x1="225" y1="220" x2="225" y2="270" stroke="#ffea00" stroke-width="1.5" opacity="0.5"/>
                        <line x1="375" y1="220" x2="375" y2="270" stroke="#ff9500" stroke-width="1.5" opacity="0.5"/>
                        <line x1="525" y1="220" x2="525" y2="270" stroke="#00ff88" stroke-width="1.5" opacity="0.5"/>
                        
                        <!-- Root Node (Level 0) -->
                        <g transform="translate(300, 25)">
                            <rect x="-50" y="-20" width="100" height="40" rx="8" fill="#111827" stroke="#00f0ff" stroke-width="2"/>
                            <text x="0" y="-3" text-anchor="middle" fill="#00f0ff" font-size="10" font-family="JetBrains Mono">THREAT</text>
                            <text x="0" y="10" text-anchor="middle" fill="#9ca3af" font-size="9">Detected</text>
                        </g>
                        
                        <!-- Level 1 Nodes -->
                        <g transform="translate(150, 115)">
                            <rect x="-55" y="-20" width="110" height="40" rx="8" fill="#111827" stroke="#a855f7" stroke-width="2"/>
                            <text x="0" y="-3" text-anchor="middle" fill="#a855f7" font-size="10" font-family="JetBrains Mono">KNOWN THREAT?</text>
                            <text x="0" y="10" text-anchor="middle" fill="#9ca3af" font-size="9">Signature Match</text>
                        </g>
                        
                        <g transform="translate(450, 115)">
                            <rect x="-55" y="-20" width="110" height="40" rx="8" fill="#111827" stroke="#a855f7" stroke-width="2"/>
                            <text x="0" y="-3" text-anchor="middle" fill="#a855f7" font-size="10" font-family="JetBrains Mono">NEW THREAT?</text>
                            <text x="0" y="10" text-anchor="middle" fill="#9ca3af" font-size="9">ML Analysis</text>
                        </g>
                        
                        <!-- Level 2 Nodes -->
                        <g transform="translate(75, 205)">
                            <rect x="-40" y="-15" width="80" height="30" rx="6" fill="rgba(255,51,102,0.2)" stroke="#ff3366" stroke-width="1.5"/>
                            <text x="0" y="4" text-anchor="middle" fill="#ff3366" font-size="9" font-family="JetBrains Mono">CRITICAL</text>
                        </g>
                        
                        <g transform="translate(225, 205)">
                            <rect x="-40" y="-15" width="80" height="30" rx="6" fill="rgba(255,234,0,0.2)" stroke="#ffea00" stroke-width="1.5"/>
                            <text x="0" y="4" text-anchor="middle" fill="#ffea00" font-size="9" font-family="JetBrains Mono">STANDARD</text>
                        </g>
                        
                        <g transform="translate(375, 205)">
                            <rect x="-40" y="-15" width="80" height="30" rx="6" fill="rgba(255,149,0,0.2)" stroke="#ff9500" stroke-width="1.5"/>
                            <text x="0" y="4" text-anchor="middle" fill="#ff9500" font-size="9" font-family="JetBrains Mono">ANALYZE</text>
                        </g>
                        
                        <g transform="translate(525, 205)">
                            <rect x="-40" y="-15" width="80" height="30" rx="6" fill="rgba(0,255,136,0.2)" stroke="#00ff88" stroke-width="1.5"/>
                            <text x="0" y="4" text-anchor="middle" fill="#00ff88" font-size="9" font-family="JetBrains Mono">MONITOR</text>
                        </g>
                        
                        <!-- Level 3 - Actions -->
                        <g transform="translate(75, 290)">
                            <rect x="-45" y="-15" width="90" height="30" rx="4" fill="#ff3366" opacity="0.3"/>
                            <text x="0" y="0" text-anchor="middle" fill="#ffffff" font-size="8" font-family="JetBrains Mono">🚨 ESCALATE</text>
                            <text x="0" y="12" text-anchor="middle" fill="#ff3366" font-size="10" font-weight="bold">${rand(3, 8)}%</text>
                        </g>
                        
                        <g transform="translate(225, 290)">
                            <rect x="-45" y="-15" width="90" height="30" rx="4" fill="#ffea00" opacity="0.2"/>
                            <text x="0" y="0" text-anchor="middle" fill="#ffffff" font-size="8" font-family="JetBrains Mono">⚡ AUTO-BLOCK</text>
                            <text x="0" y="12" text-anchor="middle" fill="#ffea00" font-size="10" font-weight="bold">${rand(35, 45)}%</text>
                        </g>
                        
                        <g transform="translate(375, 290)">
                            <rect x="-45" y="-15" width="90" height="30" rx="4" fill="#ff9500" opacity="0.2"/>
                            <text x="0" y="0" text-anchor="middle" fill="#ffffff" font-size="8" font-family="JetBrains Mono">🔍 SANDBOX</text>
                            <text x="0" y="12" text-anchor="middle" fill="#ff9500" font-size="10" font-weight="bold">${rand(15, 25)}%</text>
                        </g>
                        
                        <g transform="translate(525, 290)">
                            <rect x="-45" y="-15" width="90" height="30" rx="4" fill="#00ff88" opacity="0.2"/>
                            <text x="0" y="0" text-anchor="middle" fill="#ffffff" font-size="8" font-family="JetBrains Mono">📊 LOG</text>
                            <text x="0" y="12" text-anchor="middle" fill="#00ff88" font-size="10" font-weight="bold">${rand(25, 35)}%</text>
                        </g>
                        
                        <!-- Decision Labels -->
                        <text x="120" y="75" fill="#00ff88" font-size="8" font-family="JetBrains Mono">YES</text>
                        <text x="345" y="75" fill="#ff3366" font-size="8" font-family="JetBrains Mono">NO</text>
                    </svg>
                </div>
            `;
        }
        
        function updateWaffleChart() {
            const container = document.getElementById('waffleChart');
            const legendContainer = document.getElementById('waffleLegend');
            
            // Response status distribution (100 cells total)
            const statuses = [
                { name: 'Resolved', count: rand(55, 65), color: '#00ff88', description: 'Successfully mitigated' },
                { name: 'In Progress', count: rand(15, 22), color: '#ffea00', description: 'Being investigated' },
                { name: 'Escalated', count: rand(8, 15), color: '#ff9500', description: 'Requires attention' },
                { name: 'Critical', count: rand(3, 8), color: '#ff3366', description: 'Immediate action' }
            ];
            
            // Normalize to 100
            const total = statuses.reduce((sum, s) => sum + s.count, 0);
            let normalized = statuses.map(s => ({
                ...s,
                cells: Math.round((s.count / total) * 100)
            }));
            
            // Adjust to exactly 100
            const diff = 100 - normalized.reduce((sum, s) => sum + s.cells, 0);
            normalized[0].cells += diff;
            
            // Generate cells
            let cells = [];
            normalized.forEach(status => {
                for (let i = 0; i < status.cells; i++) {
                    cells.push(status.color);
                }
            });
            
            // Shuffle for visual appeal
            cells = cells.sort(() => Math.random() - 0.5);
            
            container.innerHTML = cells.map((color, i) => `
                <div class="w-full aspect-square rounded-sm transition-all duration-300 hover:scale-125 cursor-pointer animate-fade" 
                     style="background-color: ${color}; animation-delay: ${i * 10}ms; opacity: 0.85;"
                     title="${normalized.find(s => s.color === color)?.name}"></div>
            `).join('');
            
            // Update legend
            legendContainer.innerHTML = normalized.map(status => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-sm" style="background-color: ${status.color}"></div>
                        <span class="text-sm text-gray-300">${status.name}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-xs text-gray-500">${status.description}</span>
                        <span class="font-mono text-sm font-bold" style="color: ${status.color}">${status.cells}%</span>
                    </div>
                </div>
            `).join('');
            
            // Update MTTR
            document.getElementById('mttr').textContent = `${(rand(80, 200) / 10).toFixed(1)} min`;
        }
        
        function updateTimeSeriesChart() {
            const hours = Array.from({ length: 24 }, (_, i) => {
                const h = (new Date().getHours() - 23 + i + 24) % 24;
                return `${h.toString().padStart(2, '0')}:00`;
            });
            
            // Generate actual data
            const actual = hours.map((_, i) => {
                let base = rand(800, 1200);
                // Add patterns
                if (i > 6 && i < 18) base += rand(200, 400);
                if (i === 10 || i === 14) base += rand(300, 500);
                return base;
            });
            
            // Generate predictions (slight offset from actual)
            const predicted = actual.map((v, i) => {
                if (i < 18) return v + rand(-50, 50);
                return v + rand(100, 300); // Future prediction diverges
            });
            
            // Confidence bounds
            const upperBound = predicted.map(v => v + rand(150, 250));
            const lowerBound = predicted.map(v => Math.max(0, v - rand(150, 250)));
            
            charts.timeSeries.data.labels = hours;
            charts.timeSeries.data.datasets[0].data = actual.slice(0, 18).concat(Array(6).fill(null));
            charts.timeSeries.data.datasets[1].data = predicted;
            charts.timeSeries.data.datasets[2].data = upperBound;
            charts.timeSeries.data.datasets[3].data = lowerBound;
            charts.timeSeries.update('none');
            
            document.getElementById('forecastAccuracy').textContent = `${(rand(920, 980) / 10).toFixed(1)}%`;
            document.getElementById('predictedSpike').textContent = `+${rand(12, 25)}% in ${rand(2, 6)}h`;
        }
        
        function updateAnomalyChart() {
            const minutes = Array.from({ length: 60 }, (_, i) => {
                const m = (60 - i);
                return `-${m}m`;
            });
            minutes.push('now');
            
            const baseline = 1200;
            const threshold = 1800;
            
            // Generate traffic with anomalies
            const traffic = minutes.map((_, i) => {
                let value = baseline + rand(-200, 200);
                // Add anomaly spikes
                if (i === 15 || i === 32 || i === 45 || i === 52) {
                    value = rand(1900, 2500);
                }
                return value;
            });
            
            // Mark anomalies
            const anomalies = traffic.map((v, i) => v > threshold ? v : null);
            
            charts.anomaly.data.labels = minutes;
            charts.anomaly.data.datasets[0].data = traffic;
            charts.anomaly.data.datasets[1].data = Array(minutes.length).fill(baseline);
            charts.anomaly.data.datasets[2].data = Array(minutes.length).fill(threshold);
            charts.anomaly.data.datasets[3].data = anomalies;
            charts.anomaly.update('none');
            
            const anomalyCount = anomalies.filter(a => a !== null).length;
            const currentVal = traffic[traffic.length - 1];
            const deviation = ((currentVal - baseline) / baseline * 100).toFixed(0);
            
            document.getElementById('anomalyCount').textContent = anomalyCount;
            document.getElementById('baselineValue').textContent = `${(baseline / 1000).toFixed(1)}K/s`;
            document.getElementById('currentValue').textContent = `${(currentVal / 1000).toFixed(1)}K/s`;
            document.getElementById('deviationValue').textContent = `${deviation > 0 ? '+' : ''}${deviation}%`;
        }
        
        function updateAnomalyRange(range) {
            // Update button styles
            document.querySelectorAll('[onclick^="updateAnomalyRange"]').forEach(btn => {
                btn.className = 'px-3 py-1 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors';
            });
            event.target.className = 'px-3 py-1 text-xs font-mono bg-cyber-cyan/20 text-cyber-cyan rounded border border-cyber-cyan/30 hover:bg-cyber-cyan/30 transition-colors';
            
            updateAnomalyChart();
        }
        
        function updateStorySection() {
            const stories = [
                {
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>`,
                    title: 'Attack Volume Surge',
                    stat: '+23%',
                    description: 'Overall attack volume increased significantly this week, primarily driven by automated bot networks targeting API endpoints.',
                    color: 'cyber-red'
                },
                {
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>`,
                    title: 'Peak Attack Window',
                    stat: '02:00-05:00 UTC',
                    description: 'Most sophisticated attacks occur during off-peak hours when monitoring may be reduced. Consider 24/7 SOC coverage.',
                    color: 'cyber-orange'
                },
                {
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064"/></svg>`,
                    title: 'Primary Threat Actor',
                    stat: 'APT-41 Linked',
                    description: 'Pattern analysis suggests state-sponsored activity. Multiple TTPs match known APT-41 campaigns targeting financial sector.',
                    color: 'cyber-purple'
                },
                {
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>`,
                    title: 'Defense Effectiveness',
                    stat: '97.3%',
                    description: 'Automated defense systems successfully blocked nearly all attacks. Manual intervention required for 2.7% of incidents.',
                    color: 'cyber-green'
                },
                {
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
                    title: 'Emerging Threat',
                    stat: 'AI-Powered Phishing',
                    description: 'New wave of AI-generated phishing emails detected. Language quality significantly improved, bypassing traditional filters.',
                    color: 'cyber-yellow'
                },
                {
                    icon: `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>`,
                    title: 'Resource Impact',
                    stat: '340 Gbps Mitigated',
                    description: 'Largest DDoS attack this week reached 340 Gbps. Mitigation activated within 8 seconds, no service disruption occurred.',
                    color: 'cyber-cyan'
                }
            ];
            
            const container = document.getElementById('storySection');
            container.innerHTML = stories.map((story, i) => `
                <div class="p-5 rounded-xl bg-cyber-dark/70 border border-cyber-border hover:border-${story.color}/50 transition-all animate-fade" style="animation-delay: ${i * 0.1}s">
                    <div class="flex items-start gap-4">
                        <div class="w-12 h-12 rounded-lg bg-${story.color}/20 flex items-center justify-center text-${story.color} flex-shrink-0">
                            ${story.icon}
                        </div>
                        <div>
                            <h4 class="font-semibold text-white mb-1">${story.title}</h4>
                            <p class="text-2xl font-bold text-${story.color} mb-2">${story.stat}</p>
                            <p class="text-sm text-gray-400 leading-relaxed">${story.description}</p>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function generateIncident() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - rand(0, 60));
            
            return {
                timestamp: now.toLocaleTimeString('en-US', { hour12: false }),
                fullTimestamp: now.toISOString(),
                eventId: generateEventID(),
                type: attackTypes[rand(0, attackTypes.length - 1)],
                source: `${countries[rand(0, countries.length - 1)].flag} ${generateIP()}`,
                sourceCountry: countries[rand(0, countries.length - 1)],
                target: targets[rand(0, targets.length - 1)],
                severity: severityLevels[rand(0, severityLevels.length - 1)],
                status: Math.random() > 0.2 ? 'Mitigated' : 'Investigating',
                details: `Port ${rand(20, 8080)} | ${rand(100, 10000)} packets`
            };
        }
        
        function generateIncidents(count = 20) {
            allIncidents = Array.from({ length: count }, () => generateIncident());
            allIncidents.sort((a, b) => new Date(b.fullTimestamp) - new Date(a.fullTimestamp));
            renderIncidentsTable(allIncidents);
        }
        
        function renderIncidentsTable(incidents) {
            const container = document.getElementById('incidentsTable');
            container.innerHTML = incidents.map((incident, i) => {
                const statusClass = incident.status === 'Mitigated' ? 'text-cyber-green' : 'text-cyber-yellow';
                return `
                    <tr class="border-b border-cyber-border/50 hover:bg-cyber-border/20 transition-colors animate-slide cursor-pointer" 
                        style="animation-delay: ${i * 0.03}s"
                        onclick="openModal('${incident.type}', { count: ${rand(500, 2000)} })">
                        <td class="py-3 pr-4 font-mono text-xs text-gray-400">${incident.timestamp}</td>
                        <td class="py-3 pr-4 font-mono text-xs text-cyber-cyan">${incident.eventId}</td>
                        <td class="py-3 pr-4">
                            <span class="px-2 py-1 text-xs rounded" style="background: ${typeColors[incident.type]}20; color: ${typeColors[incident.type]}">${incident.type}</span>
                        </td>
                        <td class="py-3 pr-4 text-sm">${incident.source}</td>
                        <td class="py-3 pr-4 text-sm text-gray-400">${incident.target}</td>
                        <td class="py-3 pr-4">
                            <span class="px-2 py-1 text-xs rounded ${severityColors[incident.severity].bg} ${severityColors[incident.severity].text}">${incident.severity.toUpperCase()}</span>
                        </td>
                        <td class="py-3 pr-4 text-sm ${statusClass}">${incident.status}</td>
                        <td class="py-3 font-mono text-xs text-gray-500">${incident.details}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterIncidents() {
            const severityFilter = document.getElementById('severityFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            let filtered = allIncidents;
            
            if (severityFilter !== 'all') {
                filtered = filtered.filter(i => i.severity === severityFilter);
            }
            
            if (typeFilter !== 'all') {
                const typeMap = {
                    'ddos': 'DDoS',
                    'malware': 'Malware',
                    'phishing': 'Phishing',
                    'ransomware': 'Ransomware',
                    'injection': 'SQL Injection'
                };
                filtered = filtered.filter(i => i.type === typeMap[typeFilter]);
            }
            
            renderIncidentsTable(filtered);
        }
        
        function updateTimelineRange(range) {
            // Update button styles
            document.querySelectorAll('[onclick^="updateTimelineRange"]').forEach(btn => {
                btn.className = 'px-3 py-1 text-xs font-mono bg-cyber-border rounded hover:bg-cyber-border/70 transition-colors';
            });
            event.target.className = 'px-3 py-1 text-xs font-mono bg-cyber-cyan/20 text-cyber-cyan rounded border border-cyber-cyan/30 hover:bg-cyber-cyan/30 transition-colors';
            
            // Generate new data based on range
            updateTimelineChart();
        }
        
        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }
        
        // ================================
        // MODAL FUNCTIONS
        // ================================
        
        function openModal(attackType, attackData) {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('detailModal');
            const details = attackTypeDetails[attackType];
            
            // Set header
            document.getElementById('modalTitle').textContent = attackType.toUpperCase() + ' ATTACKS';
            document.getElementById('modalIcon').innerHTML = details.icon;
            document.getElementById('modalIcon').style.backgroundColor = details.color + '30';
            
            // Generate random stats for this attack type
            const totalCount = attackData.count || rand(500, 3000);
            const blockedPct = rand(92, 99);
            const avgSeverity = ['Low', 'Medium', 'High'][rand(0, 2)];
            const peakHour = rand(0, 23);
            
            // Populate stats
            document.getElementById('modalStats').innerHTML = `
                <div class="cyber-border rounded-lg p-4 bg-cyber-dark/50 text-center">
                    <p class="text-xs text-gray-500 font-mono mb-1">TOTAL INCIDENTS</p>
                    <p class="text-2xl font-bold" style="color: ${details.color}">${totalCount.toLocaleString()}</p>
                </div>
                <div class="cyber-border rounded-lg p-4 bg-cyber-dark/50 text-center">
                    <p class="text-xs text-gray-500 font-mono mb-1">BLOCKED RATE</p>
                    <p class="text-2xl font-bold text-cyber-green">${blockedPct}%</p>
                </div>
                <div class="cyber-border rounded-lg p-4 bg-cyber-dark/50 text-center">
                    <p class="text-xs text-gray-500 font-mono mb-1">AVG SEVERITY</p>
                    <p class="text-2xl font-bold text-cyber-orange">${avgSeverity}</p>
                </div>
                <div class="cyber-border rounded-lg p-4 bg-cyber-dark/50 text-center">
                    <p class="text-xs text-gray-500 font-mono mb-1">PEAK HOUR</p>
                    <p class="text-2xl font-bold text-cyber-cyan">${peakHour.toString().padStart(2, '0')}:00</p>
                </div>
            `;
            
            // Populate sources
            const sourceData = countries.slice(0, 5).map(c => ({
                ...c,
                count: rand(50, 500)
            })).sort((a, b) => b.count - a.count);
            
            document.getElementById('modalSources').innerHTML = sourceData.map(s => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span>${s.flag}</span>
                        <span class="text-sm text-gray-300">${s.name}</span>
                    </div>
                    <span class="font-mono text-sm" style="color: ${details.color}">${s.count}</span>
                </div>
            `).join('');
            
            // Populate targets
            const targetData = targets.slice(0, 5).map(t => ({
                name: t,
                count: rand(20, 300)
            })).sort((a, b) => b.count - a.count);
            
            document.getElementById('modalTargets').innerHTML = targetData.map(t => `
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-300">${t.name}</span>
                    <span class="font-mono text-sm text-cyber-cyan">${t.count}</span>
                </div>
            `).join('');
            
            // Populate signatures
            document.getElementById('modalSignatures').innerHTML = details.signatures.map(sig => `
                <div class="px-2 py-1 bg-cyber-dark rounded text-xs font-mono text-gray-400 border border-cyber-border">
                    ${sig}
                </div>
            `).join('');
            
            // Generate incidents for this type
            const typeIncidents = Array.from({ length: 8 }, () => {
                const inc = generateIncident();
                inc.type = attackType;
                return inc;
            });
            
            document.getElementById('modalIncidentCount').textContent = `${typeIncidents.length} incidents`;
            document.getElementById('modalIncidents').innerHTML = typeIncidents.map(inc => `
                <tr class="border-b border-cyber-border/30">
                    <td class="py-2 pr-4 font-mono text-xs text-gray-400">${inc.timestamp}</td>
                    <td class="py-2 pr-4 text-sm">${inc.source}</td>
                    <td class="py-2 pr-4 text-sm text-gray-400">${inc.target}</td>
                    <td class="py-2 pr-4">
                        <span class="px-2 py-0.5 text-xs rounded ${severityColors[inc.severity].bg} ${severityColors[inc.severity].text}">${inc.severity}</span>
                    </td>
                    <td class="py-2 text-sm ${inc.status === 'Mitigated' ? 'text-cyber-green' : 'text-cyber-yellow'}">${inc.status}</td>
                </tr>
            `).join('');
            
            // Set recommendation
            document.getElementById('modalRecommendationText').textContent = details.recommendation;
            
            // Initialize/update modal charts
            initModalCharts(attackType, details.color);
            
            // Show modal
            overlay.classList.add('active');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeModal() {
            const overlay = document.getElementById('modalOverlay');
            const modal = document.getElementById('detailModal');
            
            overlay.classList.remove('active');
            modal.classList.remove('active');
            document.body.style.overflow = '';
            
            // Destroy modal charts to prevent memory leaks
            if (modalCharts.trend) {
                modalCharts.trend.destroy();
                modalCharts.trend = null;
            }
            if (modalCharts.severity) {
                modalCharts.severity.destroy();
                modalCharts.severity = null;
            }
        }
        
        function initModalCharts(attackType, color) {
            // Destroy existing charts if they exist
            if (modalCharts.trend) modalCharts.trend.destroy();
            if (modalCharts.severity) modalCharts.severity.destroy();
            
            // Trend Chart - 24 hour data
            const trendCtx = document.getElementById('modalTrendChart').getContext('2d');
            const hours = Array.from({ length: 24 }, (_, i) => `${i.toString().padStart(2, '0')}:00`);
            const trendData = hours.map(() => rand(5, 80));
            
            modalCharts.trend = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Incidents',
                        data: trendData,
                        borderColor: color,
                        backgroundColor: color + '20',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(30, 58, 95, 0.3)' },
                            ticks: { color: '#6b7280', font: { size: 9 }, maxTicksLimit: 8 }
                        },
                        y: {
                            grid: { color: 'rgba(30, 58, 95, 0.3)' },
                            ticks: { color: '#6b7280', font: { size: 9 } }
                        }
                    }
                }
            });
            
            // Severity Chart - Horizontal bar
            const severityCtx = document.getElementById('modalSeverityChart').getContext('2d');
            const severityData = {
                critical: rand(50, 200),
                high: rand(100, 400),
                medium: rand(200, 600),
                low: rand(300, 800)
            };
            
            modalCharts.severity = new Chart(severityCtx, {
                type: 'bar',
                data: {
                    labels: ['Critical', 'High', 'Medium', 'Low'],
                    datasets: [{
                        data: Object.values(severityData),
                        backgroundColor: ['#ff3366', '#ff9500', '#ffea00', '#00f0ff'],
                        borderRadius: 4,
                        barThickness: 24
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#111827',
                            borderColor: '#1e3a5f',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: 'rgba(30, 58, 95, 0.3)' },
                            ticks: { color: '#6b7280', font: { size: 9 } }
                        },
                        y: {
                            grid: { display: false },
                            ticks: { color: '#9ca3af', font: { size: 10 } }
                        }
                    }
                }
            });
        }
        
        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
        
        // ================================
        // MAP FUNCTIONS
        // ================================
        
        let threatMap = null;
        let mapMarkers = [];
        let mapLines = [];
        let mapIncidents = [];
        let heatmapEnabled = false;
        let heatmapLayer = null;
        
        function initThreatMap() {
            // Initialize the map
            threatMap = L.map('threatMap', {
                center: [20, 0],
                zoom: 2,
                minZoom: 2,
                maxZoom: 8,
                zoomControl: true,
                attributionControl: true
            });
            
            // Add dark-themed tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(threatMap);
            
            // Generate initial incidents
            generateMapIncidents(30);
            
            // Hide loading
            setTimeout(() => {
                document.getElementById('mapLoading').style.display = 'none';
            }, 1500);
            
            // Auto-add new incidents
            setInterval(() => {
                if (mapIncidents.length < 50) {
                    addNewMapIncident();
                }
            }, 3000);
            
            // Update stats
            updateMapStats();
            setInterval(updateMapStats, 5000);
        }
        
        function generateMapIncidents(count) {
            for (let i = 0; i < count; i++) {
                const incident = createMapIncident();
                mapIncidents.push(incident);
                addMarkerToMap(incident);
            }
            updateMapEventsFeed();
        }
        
        function createMapIncident() {
            const source = countries[rand(0, countries.length - 1)];
            const target = targetLocations[rand(0, targetLocations.length - 1)];
            const severity = severityLevels[rand(0, severityLevels.length - 1)];
            const type = attackTypes[rand(0, attackTypes.length - 1)];
            const now = new Date();
            now.setMinutes(now.getMinutes() - rand(0, 120));
            
            return {
                id: generateEventID(),
                source: source,
                target: target,
                severity: severity,
                type: type,
                timestamp: now,
                ip: generateIP(),
                packets: rand(100, 50000),
                bandwidth: (Math.random() * 10).toFixed(2),
                status: Math.random() > 0.15 ? 'Blocked' : 'Investigating',
                // Add some randomness to marker position
                markerLat: source.lat + (Math.random() - 0.5) * 5,
                markerLng: source.lng + (Math.random() - 0.5) * 5
            };
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'critical': '#ff3366',
                'high': '#ff9500',
                'medium': '#ffea00',
                'low': '#00f0ff'
            };
            return colors[severity] || '#00f0ff';
        }
        
        function createCustomIcon(severity, type) {
            const color = getSeverityColor(severity);
            const size = severity === 'critical' ? 16 : severity === 'high' ? 14 : 12;
            
            return L.divIcon({
                className: 'custom-marker',
                html: `
                    <div style="position: relative;">
                        <div style="
                            width: ${size}px;
                            height: ${size}px;
                            background: ${color};
                            border-radius: 50%;
                            border: 2px solid rgba(255,255,255,0.3);
                            box-shadow: 0 0 10px ${color}, 0 0 20px ${color}40;
                            ${severity === 'critical' ? 'animation: markerPulse 1.5s ease-out infinite;' : ''}
                        "></div>
                    </div>
                `,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
        }
        
        function addMarkerToMap(incident) {
            const marker = L.marker([incident.markerLat, incident.markerLng], {
                icon: createCustomIcon(incident.severity, incident.type)
            });
            
            // Create popup content
            const popupContent = createPopupContent(incident);
            
            marker.bindPopup(popupContent, {
                className: 'incident-popup',
                maxWidth: 350,
                minWidth: 300
            });
            
            marker.on('click', function() {
                // Draw attack line when clicked
                drawAttackLine(incident);
            });
            
            marker.addTo(threatMap);
            mapMarkers.push(marker);
            
            // Optionally draw line for critical/high severity
            if (incident.severity === 'critical') {
                drawAttackLine(incident);
            }
        }
        
        function createPopupContent(incident) {
            const severityColorClass = {
                'critical': 'bg-red-500/20 text-red-400 border-red-500/30',
                'high': 'bg-orange-500/20 text-orange-400 border-orange-500/30',
                'medium': 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30',
                'low': 'bg-cyan-500/20 text-cyan-400 border-cyan-500/30'
            };
            
            const statusColor = incident.status === 'Blocked' ? 'text-green-400' : 'text-yellow-400';
            const timeAgo = getTimeAgo(incident.timestamp);
            
            return `
                <div style="padding: 16px; font-family: 'Space Grotesk', sans-serif;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <span style="font-size: 10px; font-family: 'JetBrains Mono', monospace; color: #6b7280;">${incident.id}</span>
                        <span style="
                            font-size: 10px;
                            padding: 2px 8px;
                            border-radius: 4px;
                            background: ${getSeverityColor(incident.severity)}20;
                            color: ${getSeverityColor(incident.severity)};
                            border: 1px solid ${getSeverityColor(incident.severity)}50;
                            font-weight: 600;
                        ">${incident.severity.toUpperCase()}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <span style="
                            padding: 4px 10px;
                            border-radius: 6px;
                            background: ${typeColors[incident.type]}20;
                            color: ${typeColors[incident.type]};
                            font-size: 12px;
                            font-weight: 500;
                        ">${incident.type}</span>
                        <span style="font-size: 11px; color: #9ca3af;">${timeAgo}</span>
                    </div>
                    
                    <div style="background: #0a0e17; border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div>
                                <p style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">SOURCE</p>
                                <p style="font-size: 13px; color: white;">${incident.source.flag} ${incident.source.name}</p>
                                <p style="font-size: 10px; color: #6b7280; font-family: 'JetBrains Mono', monospace;">${incident.ip}</p>
                            </div>
                            <div style="color: #6b7280;">
                                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"/>
                                </svg>
                            </div>
                            <div style="text-align: right;">
                                <p style="font-size: 10px; color: #6b7280; margin-bottom: 2px;">TARGET</p>
                                <p style="font-size: 13px; color: white;">${incident.target.name}</p>
                                <p style="font-size: 10px; color: #6b7280;">${incident.target.country}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div style="text-align: center; padding: 8px; background: #1e3a5f20; border-radius: 6px;">
                            <p style="font-size: 9px; color: #6b7280;">PACKETS</p>
                            <p style="font-size: 14px; font-weight: 600; color: #00f0ff;">${incident.packets.toLocaleString()}</p>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #1e3a5f20; border-radius: 6px;">
                            <p style="font-size: 9px; color: #6b7280;">BANDWIDTH</p>
                            <p style="font-size: 14px; font-weight: 600; color: #ff9500;">${incident.bandwidth} Gbps</p>
                        </div>
                        <div style="text-align: center; padding: 8px; background: #1e3a5f20; border-radius: 6px;">
                            <p style="font-size: 9px; color: #6b7280;">STATUS</p>
                            <p style="font-size: 14px; font-weight: 600; color: ${incident.status === 'Blocked' ? '#00ff88' : '#ffea00'};">${incident.status}</p>
                        </div>
                    </div>
                    
                    <button onclick="openModal('${incident.type}', { count: ${rand(500, 2000)} })" style="
                        width: 100%;
                        padding: 10px;
                        background: linear-gradient(135deg, #00f0ff20, #a855f720);
                        border: 1px solid #00f0ff30;
                        border-radius: 8px;
                        color: #00f0ff;
                        font-size: 12px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s;
                        font-family: 'JetBrains Mono', monospace;
                    " onmouseover="this.style.background='linear-gradient(135deg, #00f0ff30, #a855f730)'" 
                       onmouseout="this.style.background='linear-gradient(135deg, #00f0ff20, #a855f720)'">
                        VIEW FULL ANALYSIS →
                    </button>
                </div>
            `;
        }
        
        function drawAttackLine(incident) {
            // Remove existing lines
            mapLines.forEach(line => threatMap.removeLayer(line));
            mapLines = [];
            
            // Create curved line from source to target
            const source = [incident.markerLat, incident.markerLng];
            const target = [incident.target.lat, incident.target.lng];
            
            // Create polyline with gradient effect
            const line = L.polyline([source, target], {
                color: getSeverityColor(incident.severity),
                weight: 2,
                opacity: 0.8,
                dashArray: '10, 5',
                className: 'attack-line'
            }).addTo(threatMap);
            
            mapLines.push(line);
            
            // Add animated dot along the line
            animateAttackDot(source, target, incident.severity);
            
            // Remove line after delay
            setTimeout(() => {
                if (mapLines.includes(line)) {
                    threatMap.removeLayer(line);
                }
            }, 5000);
        }
        
        function animateAttackDot(source, target, severity) {
            const color = getSeverityColor(severity);
            let progress = 0;
            
            const dot = L.circleMarker(source, {
                radius: 4,
                fillColor: color,
                fillOpacity: 1,
                color: 'white',
                weight: 1
            }).addTo(threatMap);
            
            const animate = () => {
                progress += 0.02;
                if (progress <= 1) {
                    const lat = source[0] + (target[0] - source[0]) * progress;
                    const lng = source[1] + (target[1] - source[1]) * progress;
                    dot.setLatLng([lat, lng]);
                    requestAnimationFrame(animate);
                } else {
                    threatMap.removeLayer(dot);
                }
            };
            
            animate();
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ago`;
        }
        
        function addNewMapIncident() {
            const incident = createMapIncident();
            incident.timestamp = new Date();
            mapIncidents.unshift(incident);
            
            // Remove oldest if too many
            if (mapIncidents.length > 50) {
                const oldest = mapIncidents.pop();
                // Remove marker for oldest
                if (mapMarkers.length > 50) {
                    const oldMarker = mapMarkers.shift();
                    threatMap.removeLayer(oldMarker);
                }
            }
            
            addMarkerToMap(incident);
            updateMapEventsFeed();
            
            // Flash effect for new incident
            if (incident.severity === 'critical' || incident.severity === 'high') {
                drawAttackLine(incident);
            }
        }
        
        function refreshMapIncidents() {
            // Clear existing
            mapMarkers.forEach(marker => threatMap.removeLayer(marker));
            mapLines.forEach(line => threatMap.removeLayer(line));
            mapMarkers = [];
            mapLines = [];
            mapIncidents = [];
            
            // Show loading briefly
            const loading = document.getElementById('mapLoading');
            loading.style.display = 'flex';
            
            setTimeout(() => {
                generateMapIncidents(30);
                loading.style.display = 'none';
            }, 800);
        }
        
        function toggleHeatmap() {
            const btn = document.getElementById('heatmapToggle');
            heatmapEnabled = !heatmapEnabled;
            
            if (heatmapEnabled) {
                btn.classList.add('bg-cyber-cyan/20', 'text-cyber-cyan', 'border', 'border-cyber-cyan/30');
                btn.classList.remove('bg-cyber-border');
                // Add visual indicator (simplified heatmap effect)
                mapMarkers.forEach(marker => {
                    marker.setOpacity(0.3);
                });
            } else {
                btn.classList.remove('bg-cyber-cyan/20', 'text-cyber-cyan', 'border', 'border-cyber-cyan/30');
                btn.classList.add('bg-cyber-border');
                mapMarkers.forEach(marker => {
                    marker.setOpacity(1);
                });
            }
        }
        
        function updateMapStats() {
            document.getElementById('mapLiveAttacks').textContent = mapIncidents.length;
            
            const uniqueCountries = new Set(mapIncidents.map(i => i.source.code));
            document.getElementById('mapCountries').textContent = uniqueCountries.size;
            
            // Find top source
            const sourceCounts = {};
            mapIncidents.forEach(i => {
                sourceCounts[i.source.name] = (sourceCounts[i.source.name] || 0) + 1;
            });
            const topSource = Object.entries(sourceCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('mapTopSource').textContent = topSource ? topSource[0].split(' ')[0] : '--';
            
            // Find top target
            const targetCounts = {};
            mapIncidents.forEach(i => {
                targetCounts[i.target.name] = (targetCounts[i.target.name] || 0) + 1;
            });
            const topTarget = Object.entries(targetCounts).sort((a, b) => b[1] - a[1])[0];
            document.getElementById('mapTopTarget').textContent = topTarget ? topTarget[0].replace(' DC', '') : '--';
            
            document.getElementById('mapAttackRate').textContent = `${rand(15, 45)}/min`;
            document.getElementById('mapBlocked').textContent = `${rand(94, 99)}%`;
        }
        
        function updateMapEventsFeed() {
            const container = document.getElementById('mapEventsFeed');
            const recentEvents = mapIncidents.slice(0, 10);
            
            container.innerHTML = recentEvents.map(incident => `
                <div class="flex-shrink-0 w-64 p-3 rounded-lg border cursor-pointer transition-all hover:scale-105"
                     style="background: ${getSeverityColor(incident.severity)}10; border-color: ${getSeverityColor(incident.severity)}30;"
                     onclick="focusOnIncident('${incident.id}')">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-xs font-mono" style="color: ${getSeverityColor(incident.severity)};">${incident.type}</span>
                        <span class="text-xs text-gray-500">${getTimeAgo(incident.timestamp)}</span>
                    </div>
                    <p class="text-xs text-gray-400 truncate">${incident.source.flag} ${incident.source.name} → ${incident.target.name}</p>
                </div>
            `).join('');
        }
        
        function focusOnIncident(incidentId) {
            const incident = mapIncidents.find(i => i.id === incidentId);
            if (incident) {
                threatMap.setView([incident.markerLat, incident.markerLng], 5, { animate: true });
                drawAttackLine(incident);
                
                // Find and open the marker popup
                const markerIndex = mapIncidents.indexOf(incident);
                if (mapMarkers[mapMarkers.length - 1 - markerIndex]) {
                    mapMarkers[mapMarkers.length - 1 - markerIndex].openPopup();
                }
            }
        }
        
        // ================================
        // INITIALIZATION
        // ================================
        
        function init() {
            initCharts();
            initThreatMap();
            updateKPIs();
            updateTimelineChart();
            updateDistributionChart();
            updateDOSChart();
            updateGeoList();
            updateHeatmap();
            updateCorrelationInsights();
            updateStorySection();
            generateIncidents(20);
            updateLastUpdate();
            
            // New chart updates
            updateDecisionTree();
            updateExpandedDecisionTree();
            updateWaffleChart();
            updateTimeSeriesChart();
            updateAnomalyChart();
            
            // Initial live feed
            for (let i = 0; i < 5; i++) {
                setTimeout(() => updateLiveFeed(), i * 200);
            }
            
            // Set up auto-refresh intervals
            setInterval(updateLiveFeed, 5000);
            setInterval(updateLastUpdate, 1000);
            setInterval(() => {
                updateKPIs();
                updateDOSChart();
                updateAnomalyChart();
                updateTimeSeriesChart();
            }, 30000);
            
            // Update waffle chart periodically
            setInterval(updateWaffleChart, 60000);
        }
        
        // Start the dashboard
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>